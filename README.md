# Администрирование и оптимизация БД учета товаров

Практика: создание БД, индексы, представления, триггеры, роли, резервное копирование и анализ производительности. Реализация на **Python**, данные хранятся в **CSV-файлах** (каталог `data/`).

## Требования

- Python 3.8+
- Для графического интерфейса: **customtkinter** (`pip install customtkinter`)

## Установка

```bash
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
```

## Графический интерфейс (CustomTkinter)

Запуск приложения с окном и вкладками:

```bash
python app_gui.py
```

В интерфейсе: просмотр данных (товары, поставки, остатки по категориям), инициализация БД, резервная копия, восстановление, анализ производительности, оформление новой поставки.

## Создание БД (инициализация CSV)

Скрипт создаёт каталог `data/` и CSV-файлы с тестовыми данными. Если файлы уже есть и не пустые, повторно не перезаписывает:

```bash
python create_database.py
```

### Таблицы (CSV)

| Файл | Описание |
|------|----------|
| **categories.csv** | Категории товаров |
| **suppliers.csv** | Поставщики |
| **products.csv** | Товары (category_id, supplier_id, price, quantity) |
| **deliveries.csv** | Поставки (при добавлении поставки остаток товара обновляется) |

### Индексы

В модуле `csv_db` при запросах строятся индексы в памяти: по `id`, по `category_id`, `supplier_id` и т.д. — для ускорения выборок без полного перебора.

### Представления (VIEW)

В `csv_db.py` реализованы функции-представления:

- **v_products_full()** — товары с названиями категории и поставщика
- **v_deliveries_full()** — поставки с названиями товара и поставщика
- **v_stock_by_category()** — остатки и стоимость по категориям

### Триггер и процедура

- **add_delivery(...)** — при добавлении поставки автоматически увеличивается `quantity` в `products` (логика триггера).
- **sp_deliveries_report(date_from, date_to)** — отчёт по поставкам за период.

### Роли и разграничение прав

В `csv_db` две роли: **reader** (только чтение), **manager** (чтение и запись). Установка роли: `csv_db.set_role("reader")` или `csv_db.set_role("manager")`. Запись в CSV и `add_delivery()` разрешены только для роли `manager`.

## Резервное копирование

Копирует папку `data/` в `backups/products_db_YYYYMMDD_HHMMSS/`:

```bash
python backup_db.py
```

Можно указать имя папки: `python backup_db.py backups/my_backup`

## Восстановление из резервной копии

Восстанавливает CSV из указанной папки бэкапа в `data/`:

```bash
python restore_db.py backups/products_db_20250216_120000
```

## Анализ производительности

Замеряет время выполнения представлений и запросов, пишет отчёт в `reports/`:

```bash
python performance_analysis.py
```

## Итог по ТЗ

| Требование | Реализация |
|------------|------------|
| Таблицы: Товары, Категории, Поставщики, Поставки | CSV: `products.csv`, `categories.csv`, `suppliers.csv`, `deliveries.csv` |
| Индексация ключевых полей | Индексы в памяти в `csv_db` (build_index_by_id, build_index_by_key) |
| Представления (VIEW) | `v_products_full`, `v_deliveries_full`, `v_stock_by_category` в `csv_db.py` |
| Триггеры / процедуры | Триггер при поставке в `add_delivery()`; процедура `sp_deliveries_report()` |
| Анализ и оптимизация запросов | `performance_analysis.py` — замеры времени и рекомендации |
| Резервное копирование | `backup_db.py` — копирование папки `data/` |
| Восстановление | `restore_db.py` — восстановление из папки бэкапа |
| Две роли, ограничение доступа | Роли `reader` и `manager` в `csv_db`, проверка в `save_table` и `add_delivery` |

Все скрипты на Python, БД — CSV в каталоге `data/`.
